<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>AI KSHETRA Prelims | Event Registration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Futuristic font -->
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">

    {% load static %}
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <link rel="shortcut icon" href="{% static 'fav.png' %}" type="image/x-icon">
</head>

<body>
    <div class="grid-overlay"></div>
    <div class="orb"></div>

    <div class="container">
        <div class="glass-card">

            <div class="badge">
                <div class="badge-dot"></div>
                AI KSHETRA 2025 · PRELIMS
            </div>

            {% if step == 1 %}
            <!-- ================= STEP 1 ================= -->

            <div class="title-row">
                <div class="title-main">
                    Choose Your <span>Battlefield</span>
                </div>
                <p class="subtitle">
                    Welcome to the prelims hub of <strong>AI KSHETRA</strong>. Pick your event
                    and enter the <strong>team leader’s phone number</strong> to proceed.
                </p>
            </div>

            <div class="steps">
                STEP 1 · EVENT & PHONE
                <div class="steps-line"></div>
            </div>

            <form id="prelims-form" method="post">
                {% csrf_token %}

                <div class="event-grid" id="event-grid">
                    {% for quiz in quizzes %}
                    <label class="event-card{% if not quiz.is_active %} inactive{% endif %}"
                        data-event-id="quiz-{{ quiz.id }}">

                        <input class="event-radio" type="radio" name="event" value="{{ quiz.id }}">

                        <div class="event-pill">
                            <div class="event-pill-inner"></div>
                        </div>

                        <div>
                            <div class="event-content-title">
                                {{ quiz.name }}
                                {% if not quiz.is_active %}
                                <span style="font-size:11px; background:#475569; padding:2px 6px;
                         border-radius:4px; margin-left:6px;">
                                    Inactive
                                </span>
                                {% endif %}
                            </div>

                            <div class="event-content-sub">
                                {{ quiz.description|default:"No description available." }}
                            </div>
                        </div>
                    </label>
                    {% empty %}
                    <div style="grid-column:1/-1; text-align:center; opacity:.7;">
                        No active quizzes found. Please contact admin.
                    </div>
                    {% endfor %}

                </div>

                <!-- Phone section -->
                <div class="phone-section visible" id="phone-section">
                    <div class="field-label">
                        Participant Phone
                        <span>(Given at the time of Registration)</span>
                    </div>

                    <div class="input-wrap">
                        <div class="input-prefix">+91</div>
                        <input type="tel" id="phone" name="phone" class="input" maxlength="10"
                            placeholder="Enter 10-digit mobile number" inputmode="numeric" autocomplete="tel" />
                    </div>

                    <div class="error-text {% if error %}visible{% endif %}" id="error-text">
                        {{ error }}
                    </div>
                </div>

                <div class="bottom-row">
                    <p class="note-text">
                        <strong>Note:</strong> One submission per team. Use the same phone number
                        for all future communication.
                    </p>
                    <button type="submit" class="btn-primary">
                        <span>Proceed to Prelims</span>
                        <span class="icon">⟶</span>
                    </button>
                </div>
            </form>

            {% else %}
            <!-- ================= STEP 2 ================= -->

            <div class="title-row">
                <div class="title-main">
                    Confirm Your <span>Squad</span>
                </div>
                <p class="subtitle">
                    We fetched your registration details from the college server.
                    Please verify them and read the rules before starting.
                </p>
            </div>

            <div class="steps">
                STEP 2 · CONFIRM & START
                <div class="steps-line"></div>
            </div>

            <div class="confirm-block">
                <h3>Participant Details</h3>

                {% if api_error %}
                <p style="color:#f97373; font-size:13px;">
                    {{ api_error }}
                </p>
                {% endif %}

                <p><strong>Event:</strong> {{ team.event_display }}</p>
                <p><strong>Participant Name:</strong> {{ team.participant_name }}</p>
                <p><strong>Institution:</strong> {{ team.institution }}</p>
                <p><strong>Registered Phone:</strong> +91 {{ phone }}</p>
            </div>

            <div class="rules-block">
                <h3>Rules & Guidelines</h3>
                <ul class="rules-list">
                    <li>Only the registered team leader should operate the system.</li>
                    <li>Do not refresh or go back once the quiz starts.</li>
                    <li>Multiple logins or malpractice leads to disqualification.</li>
                    <li>Timer starts immediately after entry.</li>
                </ul>
            </div>

            <div class="bottom-row">
                <p class="note-text">
                    By clicking <strong>Start Prelims</strong>, you agree to the rules.
                </p>
                <button class="btn-primary" id="start-prelims-btn">
                    <span>Start Prelims</span>
                    <span class="icon">⟶</span>
                </button>
            </div>

            {% endif %}

            <div class="toast" id="toast">
                <div class="toast-dot"></div>
                <span id="toast-text">Please select an event to continue.</span>
            </div>

            <script>
                (function () {

                    {% if step == 1 %}
                    const eventCards = document.querySelectorAll(".event-card");
                    const phoneInput = document.getElementById("phone");
                    const errorText = document.getElementById("error-text");
                    const form = document.getElementById("prelims-form");
                    const toast = document.getElementById("toast");
                    const toastText = document.getElementById("toast-text");

                    function showToast(msg) {
                        toastText.textContent = msg;
                        toast.classList.add("visible");
                        setTimeout(() => toast.classList.remove("visible"), 2500);
                    }

                    function validatePhone(phone) {
                        return /^[6-9]\d{9}$/.test(phone);
                    }

                    eventCards.forEach(card => {
                        card.addEventListener("click", () => {
                            if (card.classList.contains("inactive")) {
                                showToast("This event is not active yet.");
                                return;
                            }

                            eventCards.forEach(c => c.classList.remove("selected"));
                            card.classList.add("selected");

                            card.querySelector(".event-radio").checked = true;
                        });
                    });

                    phoneInput.addEventListener("input", () => {
                        phoneInput.value = phoneInput.value.replace(/\D/g, "").slice(0, 10);
                        errorText.classList.remove("visible");
                    });

                    form.addEventListener("submit", e => {
                        const phone = phoneInput.value.trim();
                        const anySelected = [...document.querySelectorAll(".event-radio")]
                            .some(r => r.checked);

                        if (!anySelected) {
                            e.preventDefault();
                            showToast("Please select an event.");
                            return;
                        }

                        if (!validatePhone(phone)) {
                            e.preventDefault();
                            errorText.textContent = "Enter valid 10-digit mobile number.";
                            errorText.classList.add("visible");
                            phoneInput.focus();
                        }
                    });

                    {% else %}
                    const startBtn = document.getElementById("start-prelims-btn");
                    if (startBtn) {
                        startBtn.addEventListener("click", () => {
                            const phone = "{{ phone }}";
                            const eventCode = "{{ event_code }}";
                            const params = new URLSearchParams({ phone, event: eventCode });
                            window.location.href = `/quiz/${eventCode}/?${params.toString()}`;
                        });
                    }
                    {% endif %}

                })();
            </script>

        </div>
    </div>
</body>

</html>